// A-1 Plumbing Quote Form submission
// Connects to Supabase Edge Function + SendGrid
// Version: 2025-10

const ENDPOINT = "https://zzigzylypifjokskehkn.supabase.co/functions/v1/send-quote";

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("quoteForm");
  const responseMessage = document.getElementById("responseMessage");
  const submitBtn = form.querySelector("button[type='submit']");

  // Reusable helper to show messages
  function showMessage(text, color = "green") {
    responseMessage.textContent = text;
    responseMessage.style.color = color;
    responseMessage.classList.remove("hidden");
    responseMessage.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  async function handleSubmit(e) {
    e.preventDefault();
    showMessage("", ""); // clear old messages
    submitBtn.disabled = true;
    submitBtn.textContent = "Sending...";

    try {
      // Safely format date
      const rawDate = form.problem_start_date.value;
      const formattedDate = rawDate
        ? new Date(rawDate).toISOString().split("T")[0]
        : null;

      // Build payload matching backend expectations
      const data = {
        full_name: form.name.value.trim(),
        phone_number: form.phone.value.trim(),
        email: form.email.value.trim(),
        address: form.address.value.trim(),
        property_type: form.property_type.value,
        problem_description: form.problem_description.value.trim(),
        problem_start_date: formattedDate,
        issue_types: [form.problem_description.value.trim()],
      };

      // Prepare request
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        mode: "cors",
        body: JSON.stringify(data),
      });

      // Handle response
      const rawText = await res.text();
      let body;
      try {
        body = JSON.parse(rawText);
      } catch {
        body = { message: rawText };
      }

      if (res.ok) {
        showMessage("✅ Quote request submitted successfully!", "green");
        form.reset();
      } else {
        console.error("Submission failed:", body);
        const msg =
          body?.error ||
          body?.message ||
          "❌ Error submitting request. Please try again.";
        showMessage(msg, "red");
      }
    } catch (err) {
      console.error("Network or unexpected error:", err);
      showMessage(
        "❌ Network error. Please check your connection and try again.",
        "red"
      );
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Request";
    }
  }

  form.addEventListener("submit", handleSubmit);
});
